#!/usr/bin/lua
-- Clue build script
--
-- Â© 2006 David Given.
-- Clue is licensed under the Revised BSD open source license. To get the
-- full license text, see the README file.
--
-- $Id$
-- $HeadURL$
-- $LastChangedDate$

require "socket"

local benchdata = {
	{"clbg-binary-trees",              11},
	{"clbg-mandelbrot",                1000},
	{"clbg-partialsums",               250000},
	{"clbg-fannkuch",                  8},
	{"clbg-recursive",                 6},
	{"clbg-n-body",                    60000},
	{"clbg-nsieve",                    7}
}

local function exec(s)
	local i = os.execute(s)
	if (i ~= 0) then
		os.exit(0)
	end
end

local function pn(n)
	return string.format("% 8.3f", n)
end

print("", "", "", "time", "comparison factor")
for i = 1, #benchdata do
	local name, arg = unpack(benchdata[i])
	print(name..":")
	exec("gcc test/"..name..".c -o /tmp/benchmark -Os -lm")

	local t = socket.gettime()
	exec("/tmp/benchmark "..arg.." > /dev/null")
	local gcctime = socket.gettime() - t
	print("gcc:", pn(gcctime), pn(1.0))

	exec("./bin/clue -mc test/"..name..".c > /tmp/benchmark.c")
	
	t = socket.gettime()
	exec("./cluerun -e c -f /tmp/benchmark.c -- "..arg.." > /dev/null")
	local ctime = socket.gettime() - t
	print("c:", pn(ctime), pn(ctime / gcctime))
	
	exec("./cluebat test/"..name..".c /tmp/benchmark")
	
	t = socket.gettime()
	exec("./cluerun -e lua -f /tmp/benchmark.luac -- "..arg.." > /dev/null")
	local luatime = socket.gettime() - t
	print("lua:", pn(luatime), pn(luatime / gcctime))
	
	t = socket.gettime()
	exec("./cluerun -e luajit -f /tmp/benchmark.luac -- "..arg.." > /dev/null")
	local luajittime = socket.gettime() - t
	print("luajit:", pn(luajittime), pn(luajittime / gcctime))
	
	exec("./bin/clue -mjs test/"..name..".c > /tmp/benchmark.js")
	
	t = socket.gettime()
	exec("./cluerun -e smjs -f /tmp/benchmark.js -- "..arg.." > /dev/null")
	local smjstime = socket.gettime() - t
	print("smjs:", pn(smjstime), pn(smjstime / gcctime))
	
	t = socket.gettime()
	exec("./cluerun -e rhino -f /tmp/benchmark.js -- "..arg.." > /dev/null")
	local rhinotime = socket.gettime() - t
	print("rhino:", pn(rhinotime), pn(rhinotime / gcctime))
	
	exec("./bin/clue -mperl5 test/"..name..".c > /tmp/benchmark.pl")
	
	t = socket.gettime()
	exec("./cluerun -e perl5 -f /tmp/benchmark.pl -- "..arg.." > /dev/null")
	local perl5time = socket.gettime() - t
	print("perl5:", pn(perl5time), pn(perl5time / gcctime))	
end
